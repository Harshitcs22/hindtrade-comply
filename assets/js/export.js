/**
 * CBAM Calculator - Export Functions (PDF & XML)
 */

import { calculationResults, CONSTANTS } from './config.js';

/**
 * Generate PDF Certificate
 */
export function generatePDF() {
    if (!calculationResults) {
        alert('Please calculate emissions first');
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Header
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('CBAM COMPLIANCE CERTIFICATE', 105, 20, { align: 'center' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('ISO 14067 + CBAM Annex III Methodology', 105, 28, { align: 'center' });

    // Certificate Details
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Certificate Details', 20, 45);

    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    const certId = 'CBAM-' + Math.random().toString(36).substr(2, 9).toUpperCase();
    const currentDate = new Date().toLocaleDateString('en-GB');
    
    doc.text(`Certificate ID: ${certId}`, 20, 55);
    doc.text(`Issue Date: ${currentDate}`, 20, 62);
    doc.text(`Valid Until: 31 March 2026`, 20, 69);
    doc.text(`CN Code: ${calculationResults.cnCode}`, 20, 76);

    // Main Result
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(16, 185, 129);
    doc.text(`Embedded Intensity: ${calculationResults.intensity.toFixed(3)} tCO₂e/tonne`, 20, 90);
    doc.setTextColor(0, 0, 0);

    // Emissions Breakdown Table
    doc.autoTable({
        startY: 100,
        head: [['Emission Scope', 'Value (tCO₂e)']],
        body: [
            ['Scope 1 (Direct Fuel)', calculationResults.scope1.toFixed(2)],
            ['Scope 2 (Electricity)', calculationResults.scope2.toFixed(2)],
            ['Scope 3 (Precursors)', calculationResults.scope3.toFixed(2)],
            ['Total Emissions', calculationResults.total.toFixed(2)]
        ],
        theme: 'striped',
        headStyles: { fillColor: [16, 185, 129] },
        styles: { fontSize: 10 }
    });

    // Methodology
    const finalY = doc.lastAutoTable.finalY + 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Methodology:', 20, finalY);
    doc.setFont(undefined, 'normal');
    doc.text(`Grid Factor: ${CONSTANTS.GRID_FACTOR} tCO₂e/MWh (India CEA 2026)`, 20, finalY + 7);
    doc.text(`Diesel Factor: ${CONSTANTS.DIESEL_FACTOR} tCO₂e/1000L`, 20, finalY + 14);
    doc.text(`Coal Factor: ${CONSTANTS.COAL_FACTOR} tCO₂e/1000kg`, 20, finalY + 21);

    // QR Code
    const qrContainer = document.createElement('div');
    qrContainer.id = 'qr-temp';
    document.body.appendChild(qrContainer);
    
    const qrcode = new QRCode(qrContainer, {
        text: `https://hindtrade.io/verify/${certId}`,
        width: 80,
        height: 80
    });

    setTimeout(() => {
        const qrImage = qrContainer.querySelector('img');
        if (qrImage) {
            doc.addImage(qrImage.src, 'PNG', 160, finalY, 30, 30);
            doc.setFontSize(8);
            doc.text('Scan to Verify', 167, finalY + 35);
        }
        document.body.removeChild(qrContainer);

        // Footer
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text('Generated by HindTrade Comply • https://hindtrade.io', 105, 280, { align: 'center' });

        // Save
        doc.save(`CBAM-Certificate-${certId}.pdf`);
    }, 500);
}

/**
 * Generate XML Report
 */
export function generateXML() {
    if (!calculationResults) {
        alert('Please calculate emissions first');
        return;
    }

    const certId = 'CBAM-' + Math.random().toString(36).substr(2, 9).toUpperCase();
    const currentDate = new Date().toISOString();

    const xml = `<?xml version="1.0" encoding="UTF-8"?>
<CBAMReport xmlns="urn:cbam:compliance:2026">
    <Certificate>
        <ID>${certId}</ID>
        <IssueDate>${currentDate}</IssueDate>
        <ValidUntil>2026-03-31T23:59:59Z</ValidUntil>
        <CNCode>${calculationResults.cnCode}</CNCode>
    </Certificate>
    <EmbeddedEmissions>
        <TotalIntensity unit="tCO2e/tonne">${calculationResults.intensity.toFixed(3)}</TotalIntensity>
        <Scope1 unit="tCO2e">${calculationResults.scope1.toFixed(2)}</Scope1>
        <Scope2 unit="tCO2e">${calculationResults.scope2.toFixed(2)}</Scope2>
        <Scope3 unit="tCO2e">${calculationResults.scope3.toFixed(2)}</Scope3>
        <TotalEmissions unit="tCO2e">${calculationResults.total.toFixed(2)}</TotalEmissions>
    </EmbeddedEmissions>
    <Methodology>
        <Standard>ISO 14067 + CBAM Annex III</Standard>
        <GridFactor>${CONSTANTS.GRID_FACTOR}</GridFactor>
        <Country>India</Country>
    </Methodology>
    <Production>
        <Quantity unit="tonnes">${calculationResults.productionQty}</Quantity>
    </Production>
</CBAMReport>`;

    const blob = new Blob([xml], { type: 'application/xml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CBAM-Report-${certId}.xml`;
    a.click();
    URL.revokeObjectURL(url);
}
